"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const i=require("vue"),t=require("../../node_modules/three/build/three.module.js"),ee=["innerHTML"],te=i.defineComponent({name:"JBHeatMap3D",__name:"HeatMap",props:{data:{type:Array,default:()=>[]},width:{type:Number,default:600},height:{type:Number,default:500},baseSize:{type:Number,default:.1},maxHeight:{type:Number,default:3},enableOrbit:{type:Boolean,default:!0},backgroundColor:{type:String,default:"#0d1b2a"},showGridHelper:{type:Boolean,default:!0},showAxesHelper:{type:Boolean,default:!0},isStandardColor:{type:Boolean,default:!0},rotateAnimation:{type:Boolean,default:!1},rotationSpeed:{type:Number,default:.01},autoAnimate:{type:Boolean,default:!1},cameraPosition:{type:Object,default:()=>({x:5,y:5,z:5})}},setup(D,{expose:$}){const _=i.ref(0),n=D;new t.Object3D;const C=i.ref(null),w=i.ref({show:!1,x:0,y:0,content:""}),N=i.ref(n.autoAnimate);let y,M,g,b=null,A,k,E,F=null,z=[],v=0,x=0;i.onMounted(async()=>{const{OrbitControls:a}=await Promise.resolve().then(()=>require("../../node_modules/three/examples/jsm/controls/OrbitControls.js"));X(),n.enableOrbit&&(b=new a(M,g.domElement),b.enableDamping=!0,b.dampingFactor=.05),P(),window.addEventListener("mousemove",R),window.addEventListener("resize",T),C.value&&C.value.addEventListener("mouseleave",()=>{w.value.show=!1})}),i.onUnmounted(()=>{F&&cancelAnimationFrame(F),window.removeEventListener("mousemove",R),window.removeEventListener("resize",T),g.dispose()});function X(){const{backgroundColor:a,showGridHelper:e,showAxesHelper:s,cameraPosition:c}=n;y=new t.Scene,y.background=new t.Color(a),M=new t.PerspectiveCamera(75,n.width/n.height,.1,1e3),M.position.set(c.x,c.y,c.z),g=new t.WebGLRenderer({antialias:!0}),g.setSize(n.width,n.height),g.shadowMap.enabled=!0,C.value&&C.value.appendChild(g.domElement),n.enableOrbit&&b&&(b.enableDamping=!0,b.dampingFactor=.05),y.add(new t.AmbientLight(16777215,.6));const o=new t.DirectionalLight(16777215,.8);if(o.position.set(10,20,5),y.add(o),A=new t.Group,y.add(A),e){const f=Math.max(v,x)*n.baseSize*1.2,r=new t.GridHelper(f,Math.max(v,x),4473924,2236962);y.add(r)}if(s){const f=new t.AxesHelper(Math.max(v,x)*n.baseSize*.6);y.add(f)}k=new t.Raycaster,E=new t.Vector2,I()}function J(a=10,e=10){return Array.from({length:a},()=>Array.from({length:e},()=>Math.random()*15+1))}function V(a,e,s,c,o,f){let r=.1;o!==c&&(r+=(s-c)/(o-c)*n.maxHeight);const u=new t.BoxGeometry(n.baseSize,r,n.baseSize,1,8,1),H=u.attributes.position,B=u.attributes.normal,Y=[],h=o!==c?(s-c)/(o-c):0,m=[new t.Color(536927),new t.Color(4556987),new t.Color(8765155),new t.Color(12508404),new t.Color(14997468),new t.Color(16572378),new t.Color(16365218),new t.Color(16349280),new t.Color(13112870),new t.Color(11468815)];let l=[],d=0;h>=.9?(d=10,l=m.slice(0,10)):h>=.8?(d=9,l=m.slice(0,9)):h>=.7?(d=8,l=m.slice(0,8)):h>=.6?(d=7,l=m.slice(0,7)):h>=.5?(d=6,l=m.slice(0,6)):h>=.4?(d=5,l=m.slice(0,5)):h>=.3?(d=4,l=m.slice(0,4)):h>=.2?(d=3,l=m.slice(0,3)):h>=.1?(d=2,l=m.slice(0,2)):(d=1,l=m.slice(0,1));for(let L=0;L<H.count;L++){const K=H.getY(L),Q=B.getY(L);let S=new t.Color;const q=Math.max(0,Math.min(1,(K+r/2)/r));if(Q>.5)S.copy(l[l.length-1]);else if(d===1)S.copy(l[0]);else{const O=1/(d-1);let p=Math.floor(q/O);p=Math.min(p,d-2),p=Math.max(0,p);const Z=(q-p*O)/O;p>=0&&p+1<l.length?S.lerpColors(l[p],l[p+1],Z):S.copy(l[l.length-1])}Y.push(S.r,S.g,S.b)}u.setAttribute("color",new t.BufferAttribute(new Float32Array(Y),3));const W=new t.MeshBasicMaterial({vertexColors:!0}),j=new t.Mesh(u,W);return j.position.set((a-(v-1)/2)*n.baseSize,r/2,(e-(x-1)/2)*n.baseSize),j.userData={value:s,x:a,z:e},j}function U(){{const{children:a}=A;a.forEach(e=>{e instanceof t.Mesh&&(e.geometry.dispose(),(Array.isArray(e.material)?e.material:[e.material]).forEach(c=>c.dispose()))}),A.clear()}}function I(){var c;if(U(),Array.isArray(n.data)&&n.data.length>0&&n.data.every(o=>Array.isArray(o))?z=n.data.map(o=>[...o]):(console.log("数据不合法，使用默认数据"),z=J()),A.clear(),v=z.length,x=((c=z[0])==null?void 0:c.length)||0,v===0||x===0){console.warn("数据为空，无法创建热力图");return}let e=1/0,s=-1/0;for(let o=0;o<v;o++){const f=z[o];if(Array.isArray(f))for(let r=0;r<x;r++){const u=f[r];typeof u=="number"&&(u<e&&(e=u),u>s&&(s=u))}}e===1/0&&(e=0),s===-1/0&&(s=0);for(let o=0;o<v;o++){const f=z[o];if(Array.isArray(f))for(let r=0;r<x;r++){const u=f[r],H=typeof u=="number"?u:0;let B=null;n.isStandardColor,B=V(o,r,H,e,s),A.add(B)}}}function P(){F=requestAnimationFrame(P),n.rotateAnimation&&(_.value+=n.rotationSpeed,A.rotation.y=_.value),b&&b.update(),g.render(y,M)}let G=null;function R(a){if(!C.value)return;const e=C.value.getBoundingClientRect();if(a.clientX<e.left||a.clientX>e.right||a.clientY<e.top||a.clientY>e.bottom){w.value.show=!1;return}G&&cancelAnimationFrame(G),G=requestAnimationFrame(()=>{E.x=(a.clientX-e.left)/e.width*2-1,E.y=-((a.clientY-e.top)/e.height)*2+1,k.setFromCamera(E,M);const s=k.intersectObjects(A.children);if(s.length){const c=s[0].object,{value:o,x:f,z:r}=c.userData;w.value={show:!0,x:a.clientX-e.left+10,y:a.clientY-e.top-30,content:`数值: ${o.toFixed(2)}<br>位置: (${f}, ${r})`}}else w.value.show=!1})}function T(){M.aspect=n.width/n.height,M.updateProjectionMatrix(),g.setSize(n.width,n.height)}return $({refresh:I,toggleAnimation:()=>N.value=!N.value}),(a,e)=>(i.openBlock(),i.createElementBlock("div",{class:"heatmap-wrapper",style:i.normalizeStyle({width:D.width+"px",height:D.height+"px"})},[i.unref(w).show?(i.openBlock(),i.createElementBlock("div",{key:0,class:"tooltip",style:i.normalizeStyle({left:i.unref(w).x+"px",top:i.unref(w).y+"px"}),innerHTML:i.unref(w).content},null,12,ee)):i.createCommentVNode("",!0),i.createElementVNode("div",{ref_key:"containerRef",ref:C,class:"three-container"},null,512)],4))}});exports.default=te;
